{
  "uid": "ratelimit-benchmark",
  "title": "Redis Rate Limit Benchmark (Enhanced v2)",
  "tags": [
    "benchmark",
    "redis",
    "grpc",
    "envoy",
    "bottleneck"
  ],
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 4,
  "refresh": "5s",
  "panels": [
    {
      "type": "row",
      "title": "\ud83d\udcca Overview - Throughput & Latency & Errors",
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      }
    },
    {
      "type": "timeseries",
      "title": "Total Throughput (RPS)",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "sum(irate(ratelimit_requests_total[1m]))",
          "legendFormat": "App RPS"
        },
        {
          "expr": "sum(irate(envoy_http_downstream_rq_total{envoy_http_conn_manager_prefix=\"grpc\"}[1m]))",
          "legendFormat": "Envoy RPS"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 1
      }
    },
    {
      "type": "timeseries",
      "title": "End-to-End Latency",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum(rate(envoy_http_downstream_rq_time_bucket{envoy_http_conn_manager_prefix=\"grpc\"}[1m])) by (le))",
          "legendFormat": "P50"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(envoy_http_downstream_rq_time_bucket{envoy_http_conn_manager_prefix=\"grpc\"}[1m])) by (le))",
          "legendFormat": "P95"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(envoy_http_downstream_rq_time_bucket{envoy_http_conn_manager_prefix=\"grpc\"}[1m])) by (le))",
          "legendFormat": "P99"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 1
      }
    },
    {
      "type": "timeseries",
      "title": "Error Rate (%)",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 1
              },
              {
                "color": "red",
                "value": 5
              }
            ]
          }
        }
      },
      "targets": [
        {
          "expr": "sum(irate(ratelimit_redis_errors_total[1m])) / sum(irate(ratelimit_requests_total[1m])) * 100",
          "legendFormat": "Redis Errors %"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 16,
        "y": 1
      }
    },
    {
      "type": "row",
      "title": "\ud83d\udd25 Container Resources (Bottleneck Detection)",
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 9
      }
    },
    {
      "type": "timeseries",
      "title": "Container CPU Usage (%)",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          }
        }
      },
      "targets": [
        {
          "expr": "rate(container_cpu_usage_seconds_total{id=\"/docker\"}[1m]) * 100",
          "legendFormat": "Total Docker CPU"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 10
      }
    },
    {
      "type": "timeseries",
      "title": "Container Memory",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "container_memory_usage_bytes{id=\"/docker\"}",
          "legendFormat": "Total Docker Memory"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 10
      }
    },
    {
      "type": "timeseries",
      "title": "Latency Breakdown (Overhead)",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum(rate(envoy_http_downstream_rq_time_bucket{envoy_http_conn_manager_prefix=\"grpc\"}[1m])) by (le))",
          "legendFormat": "Total P99"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(ratelimit_redis_latency_seconds_bucket[1m])) by (le)) * 1000",
          "legendFormat": "Redis P99"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(envoy_http_downstream_rq_time_bucket{envoy_http_conn_manager_prefix=\"grpc\"}[1m])) by (le)) - histogram_quantile(0.99, sum(rate(ratelimit_redis_latency_seconds_bucket[1m])) by (le)) * 1000",
          "legendFormat": "App Overhead P99"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 16,
        "y": 10
      }
    },
    {
      "type": "row",
      "title": "\u2615 JVM & GC Pressure",
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 18
      }
    },
    {
      "type": "timeseries",
      "title": "GC Pressure (%)",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 5
              },
              {
                "color": "red",
                "value": 10
              }
            ]
          }
        }
      },
      "targets": [
        {
          "expr": "sum(rate(jvm_gc_pause_seconds_sum[1m])) by (instance) * 100",
          "legendFormat": "GC % - {{instance}}"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 19
      }
    },
    {
      "type": "timeseries",
      "title": "JVM Heap Memory",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "sum(jvm_memory_used_bytes{area=\"heap\"}) by (instance)",
          "legendFormat": "Used - {{instance}}"
        },
        {
          "expr": "sum(jvm_memory_max_bytes{area=\"heap\"}) by (instance)",
          "legendFormat": "Max - {{instance}}"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 19
      }
    },
    {
      "type": "timeseries",
      "title": "Thread Count",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "app_thread_active",
          "legendFormat": "Active - {{instance}}"
        },
        {
          "expr": "jvm_threads_live_threads",
          "legendFormat": "JVM Live - {{instance}}"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 16,
        "y": 19
      }
    },
    {
      "type": "row",
      "title": "\ud83d\udd34 Redis Performance",
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 27
      }
    },
    {
      "type": "timeseries",
      "title": "Redis Latency (App Side)",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "irate(ratelimit_redis_latency_seconds_sum[1m]) / irate(ratelimit_redis_latency_seconds_count[1m]) * 1000",
          "legendFormat": "Avg"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(ratelimit_redis_latency_seconds_bucket[1m])) by (le)) * 1000",
          "legendFormat": "P95"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(ratelimit_redis_latency_seconds_bucket[1m])) by (le)) * 1000",
          "legendFormat": "P99"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 28
      }
    },
    {
      "type": "timeseries",
      "title": "Redis Ops/sec",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "ops",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "irate(redis_commands_processed_total[1m])",
          "legendFormat": "Commands/sec"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 28
      }
    },
    {
      "type": "timeseries",
      "title": "Redis CPU",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "rate(redis_cpu_sys_seconds_total[1m]) + rate(redis_cpu_user_seconds_total[1m])",
          "legendFormat": "Total CPU Cores"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 16,
        "y": 28
      }
    },
    {
      "type": "row",
      "title": "\ud83d\udd34 Redis Resources",
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 36
      }
    },
    {
      "type": "timeseries",
      "title": "Redis Memory",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "redis_memory_used_bytes",
          "legendFormat": "Used"
        },
        {
          "expr": "redis_memory_max_bytes",
          "legendFormat": "Max"
        },
        {
          "expr": "redis_memory_used_rss_bytes",
          "legendFormat": "RSS"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 37
      }
    },
    {
      "type": "timeseries",
      "title": "Redis Connections & Keys",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "redis_connected_clients",
          "legendFormat": "Clients"
        },
        {
          "expr": "redis_db_keys{db=\"db0\"}",
          "legendFormat": "Keys"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 37
      }
    },
    {
      "type": "row",
      "title": "\ud83c\udf10 Envoy Load Balancer",
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 45
      }
    },
    {
      "type": "timeseries",
      "title": "Envoy RPS by Status",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "sum(rate(envoy_cluster_grpc_0{envoy_cluster_name=\"grpc_backend\"}[1m]))",
          "legendFormat": "OK status"
        },
        {
          "expr": "sum(rate(envoy_cluster_grpc_failure{envoy_cluster_name=\"grpc_backend\"}[1m]))",
          "legendFormat": "Non-OK"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 46
      }
    },
    {
      "type": "timeseries",
      "title": "Envoy Traffic: Downstream vs Upstream",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "sum(rate(envoy_http_downstream_rq_total{envoy_http_conn_manager_prefix=\"grpc\"}[1m]))",
          "legendFormat": "Downstream (Total)"
        },
        {
          "expr": "sum(rate(envoy_cluster_upstream_rq_total{envoy_cluster_name=\"grpc_backend\"}[1m]))",
          "legendFormat": "Upstream (Total)"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 46
      }
    },
    {
      "type": "timeseries",
      "title": "Envoy Connections",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 2,
            "fillOpacity": 10
          }
        }
      },
      "targets": [
        {
          "expr": "envoy_cluster_upstream_cx_active{envoy_cluster_name=\"grpc_backend\"}",
          "legendFormat": "Active Conns"
        }
      ],
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 16,
        "y": 46
      }
    },
    {
      "type": "row",
      "title": "\ud83d\udcc8 Quick Stats",
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 54
      }
    },
    {
      "type": "stat",
      "title": "RPS",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "red",
                "value": null
              },
              {
                "color": "yellow",
                "value": 1000
              },
              {
                "color": "green",
                "value": 5000
              }
            ]
          }
        }
      },
      "options": {
        "colorMode": "value",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "sum(irate(ratelimit_requests_total[1m]))"
        }
      ],
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 0,
        "y": 55
      }
    },
    {
      "type": "stat",
      "title": "P99 Latency",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 20
              },
              {
                "color": "red",
                "value": 100
              }
            ]
          }
        }
      },
      "options": {
        "colorMode": "value",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum(rate(envoy_http_downstream_rq_time_bucket{envoy_http_conn_manager_prefix=\"grpc\"}[1m])) by (le))"
        }
      ],
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 6,
        "y": 55
      }
    },
    {
      "type": "stat",
      "title": "Error %",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 1
              },
              {
                "color": "red",
                "value": 5
              }
            ]
          }
        }
      },
      "options": {
        "colorMode": "value",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "sum(irate(ratelimit_redis_errors_total[1m])) / sum(irate(ratelimit_requests_total[1m])) * 100 or vector(0)"
        }
      ],
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 12,
        "y": 55
      }
    },
    {
      "type": "stat",
      "title": "GC %",
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 5
              },
              {
                "color": "red",
                "value": 10
              }
            ]
          }
        }
      },
      "options": {
        "colorMode": "value",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "sum(rate(jvm_gc_pause_seconds_sum[1m])) * 100"
        }
      ],
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 18,
        "y": 55
      }
    }
  ]
}